name: CI

on:
  push:
    branches: [main, master, "feat/**", "fix/**"]
  pull_request:
    branches: [main, master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Build and test — Linux (GCC + Clang)
  # ===========================================================================
  build-linux:
    name: Linux (${{ matrix.compiler }}, ${{ matrix.build_type }})
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        build_type: [Release, Debug]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y cmake ninja-build cppcheck

      - name: Set compiler
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          else
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          fi

      - name: Configure
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DNETC_BUILD_TESTS=ON \
            -DNETC_BUILD_BENCH=ON \
            -DNETC_ENABLE_SANITIZERS=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }} \
            -DCMAKE_C_COMPILER=$CC

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure -j$(nproc) --timeout 60

  # ===========================================================================
  # Build and test — Windows (MSVC)
  # ===========================================================================
  build-windows:
    name: Windows (MSVC, ${{ matrix.build_type }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]
    steps:
      - uses: actions/checkout@v4

      - name: Configure
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} `
            -DNETC_BUILD_TESTS=ON `
            -DNETC_BUILD_BENCH=ON `
            -DNETC_ENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Run tests
        run: ctest --test-dir build --build-config ${{ matrix.build_type }} --output-on-failure --timeout 60

  # ===========================================================================
  # Lint — cppcheck static analysis
  # ===========================================================================
  lint:
    name: Lint (cppcheck)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: sudo apt-get update -q && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck \
            --enable=all \
            --std=c11 \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            -I include \
            -I src \
            src/ include/

  # ===========================================================================
  # Build — macOS (Apple Clang, ARM64)
  # ===========================================================================
  build-macos:
    name: macOS (Apple Clang, ${{ matrix.build_type }})
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]
    steps:
      - uses: actions/checkout@v4

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DNETC_BUILD_TESTS=ON \
            -DNETC_ENABLE_SANITIZERS=${{ matrix.build_type == 'Debug' && 'ON' || 'OFF' }}

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j$(sysctl -n hw.logicalcpu)

      - name: Run tests
        run: ctest --test-dir build --output-on-failure --timeout 60

  # ===========================================================================
  # Benchmark CI — Linux Release, all workloads, --ci-check gate
  # Uploads results as artifact; no Oodle in CI.
  # ===========================================================================
  benchmark:
    name: Benchmark CI gates
    runs-on: ubuntu-22.04
    needs: [build-linux]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y cmake ninja-build \
            zlib1g-dev liblz4-dev libzstd-dev

      - name: Configure (Release + bench + zlib + lz4 + zstd)
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DNETC_BUILD_TESTS=OFF \
            -DNETC_BUILD_BENCH=ON \
            -DNETC_ENABLE_SANITIZERS=OFF

      - name: Build bench
        run: cmake --build build --target bench -j$(nproc)

      - name: Run benchmarks (all workloads, JSON output)
        run: |
          ./build/bench/bench \
            --count=10000 \
            --warmup=500 \
            --seed=42 \
            --train=5000 \
            --compressor=all \
            --format=json \
            --output=bench_results.json

      - name: Run CI gate check (netc only, full count)
        run: |
          ./build/bench/bench \
            --count=100000 \
            --warmup=1000 \
            --seed=42 \
            --train=50000 \
            --compressor=netc \
            --ci-check \
            --format=table
        continue-on-error: true   # gates may fail on CI hardware; record but don't block

      - name: Upload benchmark results artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: bench_results.json
          retention-days: 30
